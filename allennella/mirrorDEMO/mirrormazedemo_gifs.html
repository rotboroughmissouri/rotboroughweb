<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mirror Maze Demo</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #000;
      color: #fff;
    }
    img {
      width: 80vw;
      max-width: 600px;
      border: 4px solid #fff;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
    }
    button:disabled {
      opacity: 0.3;
    }
    #statusText {
      margin-top: 20px;
      font-size: 18px;
      color: #0f0;
    }
    #narrationText {
      margin-top: 10px;
	  margin-left: 400px;
	  margin-right: 400px;
      font-size: 16px;
      color: #0ff;
    }
    #controls {
      transition: opacity 0.3s;
    }
    #controls.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #introScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    #introScreen input {
      padding: 10px;
      margin: 10px;
      font-size: 16px;
    }
    #gameScreen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
	    #popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      color: #fff;
      border: 2px solid #0ff;
      padding: 20px;
      z-index: 200;
      display: none;
    }
  </style>
</head>
<body>

  <div id="introScreen">
    <h2>Enter Your Birth Info</h2>
    <input type="number" id="birthMonth" placeholder="Birth Month" min="1" max="12">
    <input type="number" id="birthDay" placeholder="Birth Day" min="1" max="31">
    <button onclick="startMaze()">Enter</button>
  </div>

  <div id="gameScreen" style="display: none;">
    <h1>Mirror Maze Demo</h1>
    <img id="mazeView" src="" alt="Maze View"/>

    <div id="controls">
      <button id="leftBtn">Left</button>
      <button id="forwardBtn">Forward</button>
      <button id="rightBtn">Right</button>
    </div>

    <div id="statusText"></div>
    <div id="narrationText"></div>
  </div>
  
  <div id="popup"></div>

  <script>
    let birthMonth = "";
    let birthDay = "";
    let birthSign = "";

    function getAstrologicalSign(month, day) {
      const signs = [
        { sign: "Capricorn", start: [12, 22], end: [1, 19] },
        { sign: "Aquarius", start: [1, 20], end: [2, 18] },
        { sign: "Pisces", start: [2, 19], end: [3, 20] },
        { sign: "Aries", start: [3, 21], end: [4, 19] },
        { sign: "Taurus", start: [4, 20], end: [5, 20] },
        { sign: "Gemini", start: [5, 21], end: [6, 20] },
        { sign: "Cancer", start: [6, 21], end: [7, 22] },
        { sign: "Leo", start: [7, 23], end: [8, 22] },
        { sign: "Virgo", start: [8, 23], end: [9, 22] },
        { sign: "Libra", start: [9, 23], end: [10, 22] },
        { sign: "Scorpio", start: [10, 23], end: [11, 21] },
        { sign: "Sagittarius", start: [11, 22], end: [12, 21] },
      ];

      for (let s of signs) {
        const [startMonth, startDay] = s.start;
        const [endMonth, endDay] = s.end;
        if (
          (month === startMonth && day >= startDay) ||
          (month === endMonth && day <= endDay) ||
          (startMonth > endMonth && (month === startMonth || month === endMonth) &&
            ((month === startMonth && day >= startDay) || (month === endMonth && day <= endDay)))
        ) {
          return s.sign;
        }
      }
      return "Unknown";
    }

        function showPopup(message) {
      const popup = document.getElementById('popup');
      popup.textContent = message;
      popup.style.display = 'block';
      setTimeout(() => {
        popup.style.display = 'none';
      }, 5000);
    }
	
	function startMaze() {
      birthMonth = parseInt(document.getElementById('birthMonth').value);
      birthDay = parseInt(document.getElementById('birthDay').value);
      if (!birthMonth || !birthDay || birthMonth < 1 || birthMonth > 12 || birthDay < 1 || birthDay > 31) {
        alert('Please enter a valid birth month and day.');
        return;
      }
      birthSign = getAstrologicalSign(birthMonth, birthDay);
      console.log("Astrological Sign:", birthSign); // stored for later use

      document.getElementById('introScreen').style.display = 'none';
      document.getElementById('gameScreen').style.display = 'flex';
      updateView();
    }

    const directions = ['N', 'E', 'S', 'W'];
    const maze = {
      '1,1': ['S'], '1,2': ['N', 'S'], '1,3': ['N', 'S'], '1,4': ['N', 'E'], '1,5': ['S', 'E'], '1,6': ['N'],
      '2,1': ['E', 'S'], '2,2': ['N', 'S'], '2,3': ['N', 'S'], '2,4': ['N', 'W', 'E'], '2,5': ['W', 'E', 'S'], '2,6': ['N', 'E'],
      '3,1': ['W'], '3,2': ['E', 'S'], '3,3': ['N'], '3,4': ['W', 'S', 'E'], '3,5': ['N', 'W'], '3,6': ['W', 'E'],
      '4,1': ['E'], '4,2': ['W', 'E'], '4,3': ['E', 'S'], '4,4': ['N', 'W'], '4,5': ['E', 'S'], '4,6': ['N', 'W'],
      '5,1': ['W', 'E', 'S'], '5,2': ['W', 'N', 'S'], '5,3': ['N', 'W'], '5,4': ['E', 'S'], '5,5': ['W', 'N'], '5,6': ['E'],
      '6,1': ['W', 'S'], '6,2': ['N', 'S'], '6,3': ['N', 'S'], '6,4': ['W', 'N', 'S'], '6,5': ['N', 'S'], '6,6': ['N', 'W']
    };

    const narrationMap = {
      '4,6': "I did not know where the man in the mirror came from. Only that he was me. I remember looking at him deep in the eyes, then looking at his face, his eyes, his hair, his lips. As I looked him up and down, I noticed this all encompassing warmth came over me. Every time I blinked, I saw a vast desert behind and around the mirror. It didn’t initially make sense to me, but by now I was too transfixed with the mirror to care. Soon its warmth felt like a maternal embrace. I hadn’t felt security like that since childhood.",
	  '4,5': "The more I blinked the more clear the visage of the desert became. Eventually I could feel the hot air, the sun’s burning heat, and the sand at my toes. Soon several forms came into my view, palm trees, huts, and soon people. Eventually this vision was all I could see and it was then I noticed I was surrounded by people. For some reason all I could move was my eyes…",
	  '4,5,W': "Hmmm this looks familiar… WAIT, UP AHEAD THAT’S THE ENTRANCE! Let’s try this again!",
	  '5,5': "Months must have passed before I took another step. I just sat in this maternal warmth and did not move. My joints made an audible crack as I began to move again. They had grown just as comfortable as I have in their positions. I turned my head to face the villagers. They took a cautious step away from me but soon returned to their original positions and just stared at me.",
	  '5,4': "The other members of the village soon poured out to see me. They looked at me, and then at the mirror. They had asked me if I knew what it was. I told them yes, and they looked at me as if I was the oracle of the world. They asked me what it was called. I told them it was a mirror. It was just like the one in my room. They were mesmerized.",
	  '6,4': "One of the village children walked up to the mirror and said that me and the mirror were like new best friends, brought up from the ground to be with them. I didn’t think much of these words beyond them being a cute thing for a child to say, but I would soon only have these words to remember him by.",
	  '6,3': "I don’t recall how many of us went to bed that night, but what I do know is that by morning only five of us remained. The boy was among the missing. The area which once occupied the single mirror now was a hallway of mirrors. No one moved or said anything to each other the rest of the day. The sun had not moved at all. I remember thinking how strange that was but before I could think too deeply on it I had heard the voice of the boy coming from the hall of mirrors.",
	  '6,2': "All at once, the five of us stood up and rushed toward the door of the hallway. The door would not move. ",
	  '6,1': "The sun had started to set… It had distracted me entirely from the sound of his little voice. I sat down on the ground and looked up at the sky.",
	  '5,1': "I must have fallen asleep without realizing as I only remember the sun setting and then rising once more. I looked back at the hallway and it had now more corridors. One stretching east, another west. It continued like this for some time as one by one until a new hallway, corner or doorway was formed. In 3 days time it was just me and the village scribe.",
	  '5,2': "I woke up, and met with him on the penultimate day and we had a friendly chat. He told me why he became a scribe - to impress his father - and what he wrote. We both understood that even though this was more of a mutual eulogy rather than a conversation it went on as if we had been friends for years.",
	  '4,2': "He asked me if all mirrors did this to everyone, I looked at him woefully as I noticed tears began to pool in his eyes, and it was then I remembered it was his son who had vanished all those days ago.",
	  '3,2': "I couldn’t find the strength to answer him. These were the last words I heard anyone speak. The next morning he was gone. And come the morning, the door to the hallway was opened.",
	  //'3,3': "I spent my last day, walking through what was now the maze of mirrors yelling out in anguish to whatever force was responsible for taking all these people away. I asked what or who gave the mirror the right to do this. But no matter what question I asked I heard nothing. I began beating my palms against the mirror until bruises began to form and blood began pouring from my hands. I began to cry and fall to my knees. I was laying down sobbing when the echo of the boy’s voice. It caught me by surprise, I didn’t even recognize it at first. I had to sit for a moment and recollect where I had heard it before, while I was remembering I noticed I had been moving toward the sound. It led me to the corner of the maze to an open door… In the mirror was my bedroom… I took one step toward it… and down I fell… I wondered where I was going until suddenly darkness overtook my eyes. I had no voice, I could not feel anything, I could not hear anything. Why is this happening to me…",
	  '3,6': "The more I blinked the more clear the image became. It overcame my vision entirely. What I once thought was a desert quickly revealed itself to be my room. I was looking at myself. I watched as the phone rang, just like before. I was seeing what just happened. I didn’t know what to think.",
	  '2,6': "I leaned against the mirror, but as I took a step toward it, I kicked the mirror with my foot, and I watched myself turn around to face the mirror…",
	  '2,5,N': "But soon this mirage managed to slip away, and I found myself standing before a great hall of mirrors. Hundreds, thousands maybe. I once again found myself unable to move. “What is going on?” I thought. I only had two answers, turn left or right and find out.",
	  '1,5': "I followed my heart...",
	  '3,5,E': "I turned right… The more I blinked the more clear the image became. It overcame my vision entirely. What I once thought was a desert quickly revealed itself to be my room. I was looking at myself. I watched as the phone rang, just like before. I was seeing what just happened. I didn’t know what to think. ",
	  '2,6': "I leaned against the mirror, but as I took a step toward it, I kicked the mirror with my foot, and I watched myself turn around to face the mirror… ",
	  '2,5': "But soon this mirage managed to slip away, and I found myself standing before a great hall of mirrors. Hundreds, thousands maybe. I once again found myself unable to move. “What is going on?” I thought. I only had two answers, turn left or right and find out.",
	  '3,4,N': "Another fork in the path of mirrors… I heard a strange sound… Like music coming from the right, it sounded vaguely familiar. It filled my body with a warmth like before, but it was dull. From the left, a cacophony of whispers, I could just barely make out what they were saying. I thought I heard “Closer” but I wasn’t sure. Which way..?",
	  '4,4,E': "I turned right again, and as soon as I laid my foot upon the floor, the song soon became a triumphant choir of voices. My entire body went cold, and I stood in place for a few seconds. I took a breath and prepared myself to move again. The choir was now an entire army of voices singing, their volume had not raised but the closer I got the more beautiful the arrangement became. My head felt light, but not as if I was about to pass out, but like I was dreaming. It only grew and grew in complexity the closer I got, I fell to my knees and cried at how beautiful it was. I couldn’t even believe what I was hearing. ",
	  '4,3,N': "It was like the sounds of nature took the form of singing voices, one a booming thunder. I turned and voices like the sound of rain. It was then I noticed from my left the sound of two men speaking.",
	  '5,3,E': "I thought about whether to join him or to keep moving forward. He was talking to someone I think about himself. I recall hearing the word “scribe” but not understanding what it meant at the time.",
	  '5,2': "I was approaching another fork in the road, to my left It sounded like me and someone else. I was talking with him like we had been friends forever. I listened to him talk about his son and I appeared to be greatly upset by his story - tragic as it was - but it was as if I knew something he didn’t. Ahead of me however was more of these strange and alluring sounds… ",
	  '5,3,E': " ",
	  '5,1,N': "Some like the rumble of the earth. It was overwhelming. To my left was a reverberating echo and a door that was slightly open. To my right was a corner that only seemed to bring me closer to the source of the beautiful music…",
	  '6,1,E': "The music now filled my entire body. I was spellbound by the beauty of each note. I noticed I was no longer walking but rather “dancing” toward the music being strung along mindlessly as if I had lost my autonomy. All I knew was to keep following the music.",
	  '6,2,S': "On I went… Now breaking into twirls and side steps and letting the music take full control of me. The warmth I once felt burnt like a fever, and the only way to cool down was to continue moving and dancing through the halls.",
	  '6,3,S': "The influence of the music now had a death grip on my body and I was now atavistically shaking my arms and body around but then as I stepped forward…",
	  '6,4,S': "Another fork in the road, by now I had almost lost full control of my body, but the right hand path did catch my eye. But ahead was the source of the music. I danced for a while until I decided what to do.",
	  '6,5': "I stepped forward only to find the beautiful music had subsided. It reached its climax with an echoing hum that sounded like it came from every direction. I sat and tried to remember what it sounded like but the incessant humming had clouded my memory, and I was nearly deaf from the ringing it put in my ears. The sound became so intolerable I decided to step forward.",
	  '6,6': "All this seemed to stop as I heard a door open… in this moment everything culminated in all my senses. I could see, I could hear, I could feel, I could taste, I could smell. Every sense was on overdrive, the pleasure was possessive, but something was missing…",
	  //'5,6,W': "I stepped forward. Finally, the peace I had been yearning for, the release I had been waiting for. I felt as if I was flying through the door and into space and everything became true again… I had become me. Everything made so much sense now, Heaven and earth were mine… I had been made in heaven, I had ACHIEVED HEAVEN. I had been placed back within the lost firmament. I had regained truth, I had gained ME.",
	  '5,4,W': "Without realizing I spun and stepped to the right and as soon as this happened the music stopped. I stood and looked around. Wait, have I been here before? Uh… Wait. Yea this place does look familiar… Wait where am I???",
	  '5,5,S': "Okay, I shouldn’t panic. I feel as though I’ve been here before. I’m not sure why I feel that way but maybe I can find my way back if I just…",
	  '4,1': "I walked through the door only to be faced with the beginning of the maze. This time however, I turned right… Or, was it left? Huh, I can’t seem to remember where to go… I decided to turn around but there was now a wall in front of me… I tried to retrace my steps. *You are forever lost within the walls of the maze.*",
	  '2,4': "Wow, even more decisions to make… before me 2 paths. The music and the visions seemed to have subsided. Now this deafening silence overcame me. I was almost too afraid to move. I had to make a choice. ",
	  '1,4': "I decided to go left. I took a step forward and noticed I began to clench my fist and gnash my teeth. My hand was bound so tightly I was almost shocked I didn’t notice it before. It felt right for some reason.",
	  '1,3': "My hand was so tight now, my nails began cutting into my palms and blood began to leak from in between my fingers. I stopped for a second to look at the blood. I began to lap up my own blood. It filled me with IMMENSE satisfaction. I needed more. I sat for a while and studied the flavor of my own blood. It was oddly sweet. I wondered if the blood of others tasted as good as my own.",
	  '1,2': "I took another step forward but my hunger became almost intolerable. And the pain in my palms was making it hard to enjoy the pleasures of my blood. I looked ahead to one of the mirrors and saw myself surrounded by people. They appeared to be villagers in a desert. I stared at them. I began to lick my lips with anticipation.I stepped through the mirror and found myself in the village at night. I was so excited I was shivering, an old man saw me behind one of the huts and smiled at me. I smiled at him and he smiled back and walked up to me and began talking about the mirror.",
	  //'1,1,N': "I was too focused on the taste of his blood to even hear what he was saying and as he turned to grab something that fell out of his hand I beat him over the head with a nearby rock. I hadn’t noticed he had a sword on his side until now. I stared at it and smiled wide. Somehow no one else seemed to be woken up by the commotion. I withdrew the sword and cut his arm and tasted his blood. It was even sweeter than my own. I was so absorbed in the taste of his blood I carelessly took a bite of his flesh and it was even more delicious than his blood. And it was then I realized… I have an entire village of samples to take. All of them are asleep. My smile was so big it hurt. I stepped into each hut and massacred almost all of them. I thought the sun was starting to rise by the time I snapped out of this. But it was the mirror opening as if it was a door. It beckoned me to put each of the bodies into it. I did what it said. As I finished putting the last body into the mirror I saw myself. What looked back at me was someone different. But by this point it didn’t matter. I had blood to take, and a mirror to feed. When I was finished I stepped back into the mirror. And I waited to consume the rest of them…",
	  '2,3': "I stepped forward. At this point the isolation in this maze began to overtake me. I was growing increasingly paranoid. Where was this doubt coming from? I feel as though I have been waiting for this moment my whole life. Why was I so afraid now…",
	  '2,2': "I took another step forward but this dread only seemed to get stronger. I noticed I wasn’t the one moving myself forward. It was the mirror. I tried my best to turn back but I couldn’t stop moving.",
	  '2,1': "By this time I remembered something I read in my book before I entered this maze. And it helped me calm down. It said: “A river does not cut through stone with force, but through persistence. A river of force destroys and loses more than a river in flow.” With these words in mind I decided having come this far now, my only option was to embrace what would happen.",
	  //'3,1,E': "I turned toward the doorway in front of me. All my previous anxiety seemed to vanish. I wasn’t happy, I wasn’t sad. I just was. As I walked through the door the light inside of the room, I was completely overtaken and possessed with a feeling of wholeness. Everything became clear once more… I had become WHOLE.",
	  
    };
	//specialized Exit Narration
	narrationMap["1,6,S"] = {
		default: "…and I stood before a locked door, puzzled as ever. But as I stared at the man in the mirror I noticed it was ME. That same me that once made me feel so safe. That interaction felt like years ago. The smile that painted my face was the same kind you would get coming face to face with an old friend you haven’t seen in years. My eyes began to tear up, there was no emotion behind it, they fell on their own. As the first tear hit the ground, the door opened with the sound of grinding metal and an almost blinding light. I walked through; Now I see.",
		Aries: "Ar",
		Taurus: "Ta",
		Gemini: "Ge",
		Cancer: "Ca",
		Leo: "Le",
		Virgo: "Vi",
		Libra: "Li",
		Scorpio: "Sc",
		Sagittarius: "Sa",
		Capricorn: "Ca",
		Aquarius: "Aq",
		Pisces: "Pi",
	};
	narrationMap["3,1,E"] = {
		default: "I turned toward the doorway in front of me. All my previous anxiety seemed to vanish. I wasn’t happy, I wasn’t sad. I just was. As I walked through the door the light inside of the room, I was completely overtaken and possessed with a feeling of wholeness. Everything became clear once more… I had become WHOLE.",
		Aries: "Ar",
		Taurus: "Ta",
		Gemini: "Ge",
		Cancer: "Ca",
		Leo: "Le",
		Virgo: "Vi",
		Libra: "Li",
		Scorpio: "Sc",
		Sagittarius: "Sa",
		Capricorn: "Ca",
		Aquarius: "Aq",
		Pisces: "Pi",
	};
	narrationMap["3,3,S"] = {
		default: "I spent my last day, walking through what was now the maze of mirrors yelling out in anguish to whatever force was responsible for taking all these people away. I asked what or who gave the mirror the right to do this. But no matter what question I asked I heard nothing. I began beating my palms against the mirror until bruises began to form and blood began pouring from my hands. I began to cry and fall to my knees. I was laying down sobbing when the echo of the boy’s voice. It caught me by surprise, I didn’t even recognize it at first. I had to sit for a moment and recollect where I had heard it before, while I was remembering I noticed I had been moving toward the sound. It led me to the corner of the maze to an open door… In the mirror was my bedroom… I took one step toward it… and down I fell… I wondered where I was going until suddenly darkness overtook my eyes. I had no voice, I could not feel anything, I could not hear anything. Why is this happening to me…",
		Aries: "Ar",
		Taurus: "Ta",
		Gemini: "Ge",
		Cancer: "Ca",
		Leo: "Le",
		Virgo: "Vi",
		Libra: "Li",
		Scorpio: "Sc",
		Sagittarius: "Sa",
		Capricorn: "Ca",
		Aquarius: "Aq",
		Pisces: "Pi",
	};
	narrationMap["5,6,W"] = {
		default: "I stepped forward. Finally, the peace I had been yearning for, the release I had been waiting for. I felt as if I was flying through the door and into space and everything became true again… I had become me. Everything made so much sense now, Heaven and earth were mine… I had been made in heaven, I had ACHIEVED HEAVEN. I had been placed back within the lost firmament. I had regained truth, I had gained ME.",
		Aries: "Ar",
		Taurus: "Ta",
		Gemini: "Ge",
		Cancer: "Ca",
		Leo: "Le",
		Virgo: "Vi",
		Libra: "Li",
		Scorpio: "Sc",
		Sagittarius: "Sa",
		Capricorn: "Ca",
		Aquarius: "Aq",
		Pisces: "Pi",
	};
	narrationMap["1,1,N"] = {
		default: "I was too focused on the taste of his blood to even hear what he was saying and as he turned to grab something that fell out of his hand I beat him over the head with a nearby rock. I hadn’t noticed he had a sword on his side until now. I stared at it and smiled wide. Somehow no one else seemed to be woken up by the commotion. I withdrew the sword and cut his arm and tasted his blood. It was even sweeter than my own. I was so absorbed in the taste of his blood I carelessly took a bite of his flesh and it was even more delicious than his blood. And it was then I realized… I have an entire village of samples to take. All of them are asleep. My smile was so big it hurt. I stepped into each hut and massacred almost all of them. I thought the sun was starting to rise by the time I snapped out of this. But it was the mirror opening as if it was a door. It beckoned me to put each of the bodies into it. I did what it said. As I finished putting the last body into the mirror I saw myself. What looked back at me was someone different. But by this point it didn’t matter. I had blood to take, and a mirror to feed. When I was finished I stepped back into the mirror. And I waited to consume the rest of them…",
		Aries: "Ar",
		Taurus: "Ta",
		Gemini: "Ge",
		Cancer: "Ca",
		Leo: "Le",
		Virgo: "Vi",
		Libra: "Li",
		Scorpio: "Sc",
		Sagittarius: "Sa",
		Capricorn: "Ca",
		Aquarius: "Aq",
		Pisces: "Pi",
	};
	
    let position = { col: 4, row: 6 };
    let facing = 'N';
    let previousState = null;

    const preloadCache = new Set();

    function preloadImage(src) {
      if (!preloadCache.has(src)) {
        const img = new Image();
        img.src = src;
        preloadCache.add(src);
      }
    }

    function preloadNextImages() {
      const cellKey = `${position.col},${position.row}`;
      const available = maze[cellKey] || [];
      const fIndex = directions.indexOf(facing);
      const options = {
        'N': { row: position.row - 1, col: position.col },
        'E': { row: position.row, col: position.col + 1 },
        'S': { row: position.row + 1, col: position.col },
        'W': { row: position.row, col: position.col - 1 },
      };

      for (let dir of available) {
        const newDir = dir;
        let newFacing = newDir;
        let newPos = options[newDir];
        if (newPos) {
          const staticName = `${newPos.col}.${newPos.row}.${newFacing}.gif`;
          const transitionName = `${position.col}.${position.row}.${facing}_to_${newPos.col}.${newPos.row}.${newFacing}.gif`;
          preloadImage(staticName);
          preloadImage(transitionName);
        }
      }
    }

    async function updateView() {
      const view = document.getElementById('mazeView');
      const toCol = position.col;
      const toRow = position.row;
      const toFacing = facing;

      let filename = `${toCol}.${toRow}.${toFacing}.gif`;

      if (previousState) {
        const [fromCol, fromRow, fromFacing] = previousState;
        const transitionName = `${fromCol}.${fromRow}.${fromFacing}_to_${toCol}.${toRow}.${toFacing}.gif`;
        try {
          const response = await fetch(transitionName, { method: 'HEAD' });
          if (response.ok) {
            filename = transitionName;
          }
        } catch (e) {}
      }

      view.src = filename;

      const cellKey = `${toCol},${toRow}`;
	  const facingKey = `${cellKey},${facing}`;
      const available = maze[cellKey] || [];
      const fIndex = directions.indexOf(toFacing);
      const left = directions[(fIndex + 3) % 4];
      const right = directions[(fIndex + 1) % 4];
      const forward = toFacing;
	  const narration = narrationMap[facingKey] || narrationMap[cellKey] || "";
	  let narrationText = '';
	  

		if (typeof narration === 'string'){
			narrationText = narration;
		} else if (typeof narration === 'object' && narration !== null) {
			narrationText = narration[birthSign] || narration.default || '';
		}

      document.getElementById('leftBtn').disabled = !available.includes(left);
      document.getElementById('rightBtn').disabled = !available.includes(right);
      document.getElementById('forwardBtn').disabled = !available.includes(forward);

      document.getElementById('statusText').textContent = `Current Position: (${toCol}, ${toRow}) Facing: ${toFacing}`;
      document.getElementById('narrationText').textContent = narrationText;

      previousState = [toCol, toRow, toFacing];
      preloadNextImages();
    }

    function temporarilyHideControls() {
      const controls = document.getElementById('controls');
      controls.classList.add('hidden');
      setTimeout(() => controls.classList.remove('hidden'), 4000);
    }

    function moveForward() {
      switch (facing) {
        case 'N': position.row--; break;
        case 'S': position.row++; break;
        case 'E': position.col++; break;
        case 'W': position.col--; break;
      }
      updateView();
      temporarilyHideControls();
    }

    function turnLeft() {
      const i = directions.indexOf(facing);
      facing = directions[(i + 3) % 4];
      switch (facing) {
        case 'N': position.row--; break;
        case 'S': position.row++; break;
        case 'E': position.col++; break;
        case 'W': position.col--; break;
      }
      updateView();
      temporarilyHideControls();
    }

    function turnRight() {
      const i = directions.indexOf(facing);
      facing = directions[(i + 1) % 4];
      switch (facing) {
        case 'N': position.row--; break;
        case 'S': position.row++; break;
        case 'E': position.col++; break;
        case 'W': position.col--; break;
      }
      updateView();
      temporarilyHideControls();
    }

    document.getElementById('forwardBtn').onclick = moveForward;
    document.getElementById('leftBtn').onclick = turnLeft;
    document.getElementById('rightBtn').onclick = turnRight;
  </script>

</body>
</html>

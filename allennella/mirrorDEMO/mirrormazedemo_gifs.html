<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mirror Maze Demo</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #000;
      color: #fff;
    }
    img {
      width: 80vw;
      max-width: 600px;
      border: 4px solid #fff;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
    }
    button:disabled {
      opacity: 0.3;
    }
    #statusText {
      margin-top: 20px;
      font-size: 18px;
      color: #0f0;
    }
    #narrationText {
      margin-top: 10px;
      font-size: 16px;
      color: #0ff;
    }
    #controls {
      transition: opacity 0.3s;
    }
    #controls.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #introScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    #introScreen input {
      padding: 10px;
      margin: 10px;
      font-size: 16px;
    }
    #gameScreen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
	    #popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      color: #fff;
      border: 2px solid #0ff;
      padding: 20px;
      z-index: 200;
      display: none;
    }
  </style>
</head>
<body>

  <div id="introScreen">
    <h2>Enter Your Birth Info</h2>
    <input type="number" id="birthMonth" placeholder="Birth Month" min="1" max="12">
    <input type="number" id="birthDay" placeholder="Birth Day" min="1" max="31">
    <button onclick="startMaze()">Enter</button>
  </div>

  <div id="gameScreen" style="display: none;">
    <h1>Mirror Maze Demo</h1>
    <img id="mazeView" src="" alt="Maze View"/>

    <div id="controls">
      <button id="leftBtn">Left</button>
      <button id="forwardBtn">Forward</button>
      <button id="rightBtn">Right</button>
    </div>

    <div id="statusText"></div>
    <div id="narrationText"></div>
  </div>
  
  <div id="popup"></div>

  <script>
    let birthMonth = "";
    let birthDay = "";
    let birthSign = "";

    function getAstrologicalSign(month, day) {
      const signs = [
        { sign: "Capricorn", start: [12, 22], end: [1, 19] },
        { sign: "Aquarius", start: [1, 20], end: [2, 18] },
        { sign: "Pisces", start: [2, 19], end: [3, 20] },
        { sign: "Aries", start: [3, 21], end: [4, 19] },
        { sign: "Taurus", start: [4, 20], end: [5, 20] },
        { sign: "Gemini", start: [5, 21], end: [6, 20] },
        { sign: "Cancer", start: [6, 21], end: [7, 22] },
        { sign: "Leo", start: [7, 23], end: [8, 22] },
        { sign: "Virgo", start: [8, 23], end: [9, 22] },
        { sign: "Libra", start: [9, 23], end: [10, 22] },
        { sign: "Scorpio", start: [10, 23], end: [11, 21] },
        { sign: "Sagittarius", start: [11, 22], end: [12, 21] },
      ];

      for (let s of signs) {
        const [startMonth, startDay] = s.start;
        const [endMonth, endDay] = s.end;
        if (
          (month === startMonth && day >= startDay) ||
          (month === endMonth && day <= endDay) ||
          (startMonth > endMonth && (month === startMonth || month === endMonth) &&
            ((month === startMonth && day >= startDay) || (month === endMonth && day <= endDay)))
        ) {
          return s.sign;
        }
      }
      return "Unknown";
    }

        function showPopup(message) {
      const popup = document.getElementById('popup');
      popup.textContent = message;
      popup.style.display = 'block';
      setTimeout(() => {
        popup.style.display = 'none';
      }, 5000);
    }
	
	function startMaze() {
      birthMonth = parseInt(document.getElementById('birthMonth').value);
      birthDay = parseInt(document.getElementById('birthDay').value);
      if (!birthMonth || !birthDay || birthMonth < 1 || birthMonth > 12 || birthDay < 1 || birthDay > 31) {
        alert('Please enter a valid birth month and day.');
        return;
      }
      birthSign = getAstrologicalSign(birthMonth, birthDay);
      console.log("Astrological Sign:", birthSign); // stored for later use

      document.getElementById('introScreen').style.display = 'none';
      document.getElementById('gameScreen').style.display = 'flex';
      updateView();
    }

    const directions = ['N', 'E', 'S', 'W'];
    const maze = {
      '1,1': ['S'], '1,2': ['N', 'S'], '1,3': ['N', 'S'], '1,4': ['N', 'E'], '1,5': ['S', 'E'], '1,6': ['N'],
      '2,1': ['E', 'S'], '2,2': ['N', 'S'], '2,3': ['N', 'S'], '2,4': ['N', 'W', 'E'], '2,5': ['W', 'E', 'S'], '2,6': ['N', 'E'],
      '3,1': ['W'], '3,2': ['E', 'S'], '3,3': ['N'], '3,4': ['W', 'S', 'E'], '3,5': ['N', 'W'], '3,6': ['W', 'E'],
      '4,1': ['E'], '4,2': ['W', 'E'], '4,3': ['E', 'S'], '4,4': ['N', 'W'], '4,5': ['E', 'S'], '4,6': ['N', 'W'],
      '5,1': ['W', 'E', 'S'], '5,2': ['W', 'N', 'S'], '5,3': ['N', 'W'], '5,4': ['E', 'S'], '5,5': ['W', 'N'], '5,6': ['E'],
      '6,1': ['W', 'S'], '6,2': ['N', 'S'], '6,3': ['N', 'S'], '6,4': ['W', 'N', 'S'], '6,5': ['N', 'S'], '6,6': ['N', 'W']
    };

    const narration = {
      '4,6': "I did not know where the man in the mirror came from. Only that he was me. His touch kept me warm, made me feel safe, as a mother’s hug does to her child.",
	  '3,6': "Every part of my body was flush with my Love. This love, once a whisper, soon became an uproarious chorus of warmth and inner peace.",
	  '2,6': "It wasn't long before all external needs; namely my hunger, my thirst and my need to blink, soon became a thing of the past. Soon I no longer even needed to breathe.",
	  '2,5': "After shedding these trivialities it was then when what became apparent. Yet here I stood looking at the floor like a child, longing for my mother.",
	  '3,5': "Months must have passed before I took another step. I just sat in this maternal warmth and did not move, My joints almost snapped as I walked forward.",
	  '3,4': "They had grown just as comfortable as I have in their positions. With each crack of their animation I looked forward and saw what I believed to be a village and I took my rest there. Until…",
	  '4,4': "In the morning I found the mirror from my room had been in the sand before me. I don’t know how it got there, but I remember that it shined like the sun.",
	  '4,3': "The other members of the village came to face the mirror. They had asked me if I knew what it was. I told them yes, and they looked at me as if I was the oracle of the world.",
	  '5,3': "They asked me what it was called. I told them it was a mirror and just like when I initially stepped into it, they were mesmerized.",
	  '5,2': "One of the village children walked up to the mirror and said that the mirror was like a new best friend, brought up from the ground to be with us.",
	  '5,1': "While I initially thought these words were cute, I would soon only have these words to remember him by.",
	  '6,1': "I don’t recall how many of us went to bed that night, but what I do know is that by morning only five of us remained. The boy was among the missing.",
	  '6,2': "The area which once occupied the single mirror now was a hallway of mirrors. No one moved or said anything to each other the rest of the day. The sun had not moved at all.",
	  '6,3': "I remember thinking how strange that was but before I could think too deeply on it I had heard the voice of the boy coming from the hall of mirrors.",
	  '6,4': "In 3 days time it was just me and the village scribe. I woke up, and met with him on the penultimate day and we had a friendly chat.",
	  '6,5': "He asked me if mirrors did this to everyone. I looked at him woefully when I noticed tears began to pool in his eyes, and it was then I remembered it was his son who had vanished.",
	  '6,6': "The next morning he was gone. And come the morning, the door to the hallway was opened. I spent my last day, walking through what was now the maze of mirrors yelling out in anguish. I began to cry and fall to my knees. I was laying down sobbing when the echo of the boy’s voice. It led me to the corner of the maze to an open door… In the mirror was my bedroom… I took one step toward it… and down I fell…",
    };

    let position = { col: 4, row: 6 };
    let facing = 'N';
    let previousState = null;

    const preloadCache = new Set();

    function preloadImage(src) {
      if (!preloadCache.has(src)) {
        const img = new Image();
        img.src = src;
        preloadCache.add(src);
      }
    }

    function preloadNextImages() {
      const cellKey = `${position.col},${position.row}`;
      const available = maze[cellKey] || [];
      const fIndex = directions.indexOf(facing);
      const options = {
        'N': { row: position.row - 1, col: position.col },
        'E': { row: position.row, col: position.col + 1 },
        'S': { row: position.row + 1, col: position.col },
        'W': { row: position.row, col: position.col - 1 },
      };

      for (let dir of available) {
        const newDir = dir;
        let newFacing = newDir;
        let newPos = options[newDir];
        if (newPos) {
          const staticName = `${newPos.col}.${newPos.row}.${newFacing}.gif`;
          const transitionName = `${position.col}.${position.row}.${facing}_to_${newPos.col}.${newPos.row}.${newFacing}.gif`;
          preloadImage(staticName);
          preloadImage(transitionName);
        }
      }
    }

    async function updateView() {
      const view = document.getElementById('mazeView');
      const toCol = position.col;
      const toRow = position.row;
      const toFacing = facing;

      let filename = `${toCol}.${toRow}.${toFacing}.gif`;

      if (previousState) {
        const [fromCol, fromRow, fromFacing] = previousState;
        const transitionName = `${fromCol}.${fromRow}.${fromFacing}_to_${toCol}.${toRow}.${toFacing}.gif`;
        try {
          const response = await fetch(transitionName, { method: 'HEAD' });
          if (response.ok) {
            filename = transitionName;
          }
        } catch (e) {}
      }

      view.src = filename;

      const cellKey = `${toCol},${toRow}`;
      if (cellKey === '5,6') {
        setTimeout(() => showPopup(`Your astrological sign is: ${birthSign}`), 20000);
      }
      const available = maze[cellKey] || [];
      const fIndex = directions.indexOf(toFacing);
      const left = directions[(fIndex + 3) % 4];
      const right = directions[(fIndex + 1) % 4];
      const forward = toFacing;

      document.getElementById('leftBtn').disabled = !available.includes(left);
      document.getElementById('rightBtn').disabled = !available.includes(right);
      document.getElementById('forwardBtn').disabled = !available.includes(forward);

      document.getElementById('statusText').textContent = `Current Position: (${toCol}, ${toRow}) Facing: ${toFacing}`;
      document.getElementById('narrationText').textContent = narration[cellKey] || "The mirrored halls stretch endlessly in every direction.";

      previousState = [toCol, toRow, toFacing];
      preloadNextImages();
    }

    function temporarilyHideControls() {
      const controls = document.getElementById('controls');
      controls.classList.add('hidden');
      setTimeout(() => controls.classList.remove('hidden'), 4000);
    }

    function moveForward() {
      switch (facing) {
        case 'N': position.row--; break;
        case 'S': position.row++; break;
        case 'E': position.col++; break;
        case 'W': position.col--; break;
      }
      updateView();
      temporarilyHideControls();
    }

    function turnLeft() {
      const i = directions.indexOf(facing);
      facing = directions[(i + 3) % 4];
      switch (facing) {
        case 'N': position.row--; break;
        case 'S': position.row++; break;
        case 'E': position.col++; break;
        case 'W': position.col--; break;
      }
      updateView();
      temporarilyHideControls();
    }

    function turnRight() {
      const i = directions.indexOf(facing);
      facing = directions[(i + 1) % 4];
      switch (facing) {
        case 'N': position.row--; break;
        case 'S': position.row++; break;
        case 'E': position.col++; break;
        case 'W': position.col--; break;
      }
      updateView();
      temporarilyHideControls();
    }

    document.getElementById('forwardBtn').onclick = moveForward;
    document.getElementById('leftBtn').onclick = turnLeft;
    document.getElementById('rightBtn').onclick = turnRight;
  </script>

</body>
</html>
